-- Show running query --
EXEC SP_WHO2

-- Get full query from pid --
DBCC INPUTBUFFER(PID)
GO

-- Kill a query --
KILL (PID)

-- Set server in single user mode ("recovery" mode) --
ALTER DATABASE [DB]
SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
GO

-- Set server in multiuser mode ("normal" mode) --
ALTER DATABASE [DB]
SET MULTI_USER;
GO

-- New base account for db --
USE [master]
GO
CREATE LOGIN [APP-USER] WITH PASSWORD="xxx", DEFAULT_DATABASE=[DB-NAME], CHECK_EXPIRATION=OFF, CHECK_POLICY=ON
GO
USE [DB-NAME]
GO
CREATE USER [APP-USER] FOR LOGIN [APP-USER]
GO
USE [DB-NAME]
GO
ALTER ROLE [db_datareader] ADD MEMBER [APP-USER]
GO
USE [DB-NAME]
GO
ALTER ROLE [db_datawriter] ADD MEMBER [APP-USER]
GO

-- New admin account for db --
USE [master]
GO
CREATE LOGIN [ADM-USER] WITH PASSWORD='xxx', DEFAULT_DATABASE=[DB-USER], CHECK_EXPIRATION=OFF, CHECK_POLICY=ON
GO
USE [DB-USER]
GO
CREATE USER [ADM-USER] FOR LOGIN [ADM-USER]
GO
USE [DB-USER]
GO
ALTER ROLE [db_owner] ADD MEMBER [ADM-USER]
GO

-- Create new db with Microsoft best practies --
CREATE DATABASE [DB-NAME]
 CONTAINMENT = NONE
 ON  PRIMARY 
( NAME = "DB-NAME", FILENAME = "E:\MSSQLSERVER\DB-NAME.mdf" , SIZE = 100MB , MAXSIZE = 1GB , FILEGROWTH = 65536KB )
 LOG ON 
( NAME = "DB-NAME-LOG", FILENAME = "F:\MSSQLSERVER\DB-NAME.ldf" , SIZE = 100MB , MAXSIZE = 1GB , FILEGROWTH = 65536KB )
GO
ALTER DATABASE [DB-NAME] SET ANSI_NULL_DEFAULT OFF 
GO
ALTER DATABASE [DB-NAME] SET ANSI_NULLS OFF 
GO
ALTER DATABASE [DB-NAME] SET ANSI_PADDING OFF 
GO
ALTER DATABASE [DB-NAME] SET ANSI_WARNINGS OFF 
GO
ALTER DATABASE [DB-NAME] SET ARITHABORT OFF 
GO
ALTER DATABASE [DB-NAME] SET AUTO_CLOSE OFF 
GO
ALTER DATABASE [DB-NAME] SET AUTO_SHRINK OFF 
GO
ALTER DATABASE [DB-NAME] SET AUTO_UPDATE_STATISTICS ON 
GO
ALTER DATABASE [DB-NAME] SET CURSOR_CLOSE_ON_COMMIT OFF 
GO
ALTER DATABASE [DB-NAME] SET CURSOR_DEFAULT  GLOBAL 
GO
ALTER DATABASE [DB-NAME] SET CONCAT_NULL_YIELDS_NULL OFF 
GO
ALTER DATABASE [DB-NAME] SET NUMERIC_ROUNDABORT OFF 
GO
ALTER DATABASE [DB-NAME] SET QUOTED_IDENTIFIER OFF 
GO
ALTER DATABASE [DB-NAME] SET RECURSIVE_TRIGGERS OFF 
GO
ALTER DATABASE [DB-NAME] SET  DISABLE_BROKER 
GO
ALTER DATABASE [DB-NAME] SET AUTO_UPDATE_STATISTICS_ASYNC OFF 
GO
ALTER DATABASE [DB-NAME] SET DATE_CORRELATION_OPTIMIZATION OFF 
GO
ALTER DATABASE [DB-NAME] SET PARAMETERIZATION SIMPLE 
GO
ALTER DATABASE [DB-NAME] SET READ_COMMITTED_SNAPSHOT OFF 
GO
ALTER DATABASE [DB-NAME] SET  READ_WRITE 
GO
ALTER DATABASE [DB-NAME] SET RECOVERY SIMPLE 
GO
ALTER DATABASE [DB-NAME] SET  MULTI_USER 
GO
ALTER DATABASE [DB-NAME] SET PAGE_VERIFY CHECKSUM  
GO
ALTER DATABASE [DB-NAME] SET TARGET_RECOVERY_TIME = 60 SECONDS 
GO

-- Copy / Move database --
USE [DB-NAME]
ALTER DATABASE [DB-NAME] SET OFFLINE;
ALTER DATABASE [DB-NAME] MODIFY FILE ( NAME = logical_name, FILENAME = 'new_path\os_file_name' );
-- move file from explorer to new location
ALTER DATABASE [DB-NAME] SET ONLINE;

-- Fix login after a restore with override --
USE [DB]  
GO  
EXEC sp_change_users_login 'Auto_Fix', 'User', NULL, 'password';  
GO  

-- Get all db with size on disk --
SELECT
    @@SERVERNAME as SRV,
    @@SERVICENAME as INSTANCE,
    @@LANGUAGE as DEFAULTLANGUAGE,
    @@CONNECTIONS as LOGINS,
    DETAIL.name,
    type_desc =
    FILES.physical_name,
    CONVERT(DECIMAL(10,2),(FILES.size * 8.00) / 1024.00 / 1024.00) As UsedSpaceInGB,
    CONVERT(DECIMAL(10,2),(FILES.size * 8.00) / 1024.00) As UsedSpaceInMB,
    DETAIL.database_id,
    DETAIL.create_date, 
    DETAIL.compatibility_level,
    DETAIL.collation_name,
    DETAIL.user_access_desc,
    DETAIL.state_desc,
    DETAIL.is_auto_shrink_on,
    DETAIL.recovery_model_desc,
    DETAIL.page_verify_option_desc,
    DETAIL.is_auto_create_stats_on,
    DETAIL.is_auto_update_stats_on
FROM sys.databases as DETAIL
INNER JOIN sys.master_files as FILES ON FILES.database_id = DETAIL.database_id
